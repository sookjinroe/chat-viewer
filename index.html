<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Chat Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <style>
        /* ... 이전 스타일 유지 ... */

        .current-file {
            margin: 12px 20px;
            padding: 8px 12px;
            background-color: #f8f9fa;
            border-radius: 6px;
            font-size: 0.875rem;
            color: #666;
        }

        .current-file.active {
            background-color: #e3f2fd;
            color: #1a73e8;
        }
    </style>
</head>
<body>
    <div class="card">
        <div class="card-header">
            <h1 class="card-title">
                📁 Markdown Chat Viewer
            </h1>
        </div>
        <div class="card-content">
            <div class="file-upload">
                <label>Upload your markdown file:</label>
                <input type="file" accept=".md,.txt,.csv" id="fileInput">
            </div>
            <div id="currentFileName" class="current-file"></div>
            <div class="controls">
                <select id="sessionSelect" class="session-select">
                    <option value="all">All Sessions</option>
                </select>
            </div>
            <div class="messages" id="messagesContainer"></div>
        </div>
    </div>

    <script>
        let allMessages = [];
        let currentSession = 'all';

        const roleIcons = {
            'User': '👤',
            'Planner': '📋',
            'Researcher': '🔍',
            'Reviewer': '✅',
            'Assistant': '🤖',
        };

        marked.setOptions({
            breaks: true,
            gfm: true
        });

        // localStorage 관련 함수들
        function saveToLocalStorage(file, fileContent, selectedSession) {
            localStorage.setItem('savedFileName', file.name);
            localStorage.setItem('savedContent', fileContent);
            localStorage.setItem('selectedSession', selectedSession || 'all');
            
            updateFileNameDisplay(file.name);
        }

        function loadFromLocalStorage() {
            const savedContent = localStorage.getItem('savedContent');
            const savedSession = localStorage.getItem('selectedSession') || 'all';
            const savedFileName = localStorage.getItem('savedFileName');
            
            if (savedContent && savedFileName) {
                allMessages = formatMarkdown(savedContent);
                updateSessionList();
                currentSession = savedSession;
                document.getElementById('sessionSelect').value = savedSession;
                displayMessages(filterMessagesBySession(allMessages, currentSession));
                updateFileNameDisplay(savedFileName);
            }
        }

        function updateFileNameDisplay(fileName) {
            const fileLabel = document.getElementById('currentFileName');
            if (fileName) {
                fileLabel.textContent = `Current file: ${fileName}`;
                fileLabel.classList.add('active');
            } else {
                fileLabel.textContent = 'No file loaded';
                fileLabel.classList.remove('active');
            }
        }

        // 이벤트 리스너들
        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    saveToLocalStorage(file, content, 'all');
                    allMessages = formatMarkdown(content);
                    updateSessionList();
                    displayMessages(allMessages);
                };
                reader.readAsText(file);
            }
        });

        document.getElementById('sessionSelect').addEventListener('change', function(event) {
            currentSession = event.target.value;
            const savedContent = localStorage.getItem('savedContent');
            const savedFileName = localStorage.getItem('savedFileName');
            if (savedContent && savedFileName) {
                saveToLocalStorage({name: savedFileName}, savedContent, currentSession);
            }
            displayMessages(filterMessagesBySession(allMessages, currentSession));
        });

        // 페이지 로드시 저장된 데이터 불러오기
        document.addEventListener('DOMContentLoaded', function() {
            updateFileNameDisplay(null);  // 초기 상태 표시
            loadFromLocalStorage();
        });

        /* ... 나머지 기존 함수들 유지 (formatMarkdown, updateSessionList, filterMessagesBySession, getRoleClass, displayMessages) ... */

    </script>
</body>
</html>
